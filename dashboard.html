<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Studio</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header Component -->
        <header id="mainHeader" class="main-header">
            <div class="header-content">
                <h1 class="logo" onclick="window.location.href='/dashboard.html'">
                    AI<span>STUDIO</span>
                </h1>
                
                <div class="user-menu">
                    <!-- Google Drive Settings -->
                    <button onclick="openDriveSettings()" class="btn btn-small" style="margin-right: 10px;">
                        <span>üìÅ</span> Drive Ordner
                    </button>
                    
                    <div class="user-dropdown">
                        <span id="userEmail">User</span>
                        <button onclick="signOut()" class="btn btn-small">Abmelden</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h2>Willkommen zur√ºck!</h2>
                <p>Was m√∂chtest du heute fotografieren?</p>
                
                <!-- Drive Status -->
                <div id="driveStatus" class="drive-status" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; display: none;">
                    <p style="margin: 0;">üìÅ Google Drive Ordner: <strong id="driveFolderPath">Nicht konfiguriert</strong></p>
                </div>
            </section>

            <!-- Use Cases -->
            <section class="section">
                <h3 class="section-title">W√§hle deinen Use Case</h3>
                <div class="use-case-grid">
                    <!-- Fashion -->
                    <div class="use-case-card" onclick="navigateTo('/pages/fashion.html')">
                        <div class="card-badge">Beliebt</div>
                        <div class="card-icon">üëó</div>
                        <h4>Fashion & Apparel</h4>
                        <p>Kleidung, Schuhe & Accessoires auf Models</p>
                        <div class="card-features">
                            <span>UGC Content</span>
                            <span>Spiegel-Selfies</span>
                            <span>iPhone Shots</span>
                            <span>Model-Konfiguration</span>
                        </div>
                    </div>

                    <!-- Product -->
                    <div class="use-case-card" onclick="navigateTo('/pages/product.html')">
                        <div class="card-badge">Erweitert</div>
                        <div class="card-icon">üì¶</div>
                        <h4>Product Photography</h4>
                        <p>Objekte in Aktion & Produktdemos</p>
                        <div class="card-features">
                            <span>Hand Modeling</span>
                            <span>In-Use Demos</span>
                            <span>UGC Style</span>
                            <span>360¬∞ Views</span>
                        </div>
                    </div>

                    <!-- Beauty -->
                    <div class="use-case-card" onclick="navigateTo('/pages/beauty.html')">
                        <div class="card-badge">Premium</div>
                        <div class="card-icon">üíÑ</div>
                        <h4>Beauty & Cosmetics</h4>
                        <p>Makeup, Skincare & Haircare</p>
                        <div class="card-features">
                            <span>Application Shots</span>
                            <span>Before/After</span>
                            <span>Texture Macros</span>
                        </div>
                    </div>

                    <!-- Food -->
                    <div class="use-case-card" onclick="navigateTo('/pages/food.html')">
                        <div class="card-icon">üçî</div>
                        <h4>Food & Beverage</h4>
                        <p>Restaurant-Style & Verpackungen</p>
                        <div class="card-features">
                            <span>Styled Plating</span>
                            <span>Action Cooking</span>
                            <span>Packaging Hero</span>
                        </div>
                    </div>

                    <!-- Jewelry -->
                    <div class="use-case-card" onclick="navigateTo('/pages/jewelry.html')">
                        <div class="card-icon">üíé</div>
                        <h4>Jewelry & Watches</h4>
                        <p>Schmuck & Luxury Items</p>
                        <div class="card-features">
                            <span>Macro Details</span>
                            <span>Luxury Staging</span>
                            <span>Worn Shots</span>
                        </div>
                    </div>

                    <!-- Sports -->
                    <div class="use-case-card" onclick="navigateTo('/pages/sports.html')">
                        <div class="card-icon">‚öΩ</div>
                        <h4>Sports & Fitness</h4>
                        <p>Equipment & Activewear</p>
                        <div class="card-features">
                            <span>Action Shots</span>
                            <span>Equipment Demo</span>
                            <span>Lifestyle Active</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Google Drive Settings Modal -->
    <div id="driveSettingsModal" class="modal">
        <div class="modal-content">
            <h3>Google Drive Einstellungen</h3>
            <p>Gib den Link zu deinem Google Drive Ordner ein, in dem die generierten Bilder gespeichert werden sollen:</p>
            
            <div class="form-group" style="margin: 20px 0;">
                <label>Google Drive Ordner Link:</label>
                <input type="text" 
                       id="driveFolderLink" 
                       placeholder="https://drive.google.com/drive/folders/..." 
                       class="form-control"
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Der Ordner muss f√ºr Make.com freigegeben sein
                </small>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeDriveSettings()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveDriveSettings()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vnodqwehipwpusrthurk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZub2Rxd2VoaXB3cHVzcnRodXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTA5NTcsImV4cCI6MjA3MDMyNjk1N30.LSMyYLt7URx1G1NFKZAqXTrzVHwjtbvOzeuxLZy0u-Q';
        
        let supabase = null;
        let isCheckingAuth = false;

        async function checkAuth() {
            if (isCheckingAuth) return;
            isCheckingAuth = true;

            console.log('üîí Checking authentication...');

            try {
                // Initialize Supabase
                if (!supabase && typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }

                if (!supabase) {
                    console.error('Supabase not initialized');
                    showError();
                    return;
                }

                // Check session
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('Session check error:', error);
                    showError();
                    return;
                }

                if (session) {
                    console.log('‚úÖ User authenticated:', session.user.email);
                    document.getElementById('userEmail').textContent = session.user.email;
                    
                    // Load Drive settings
                    loadDriveSettings();
                    
                    // Setup auth listener for logout
                    supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_OUT') {
                            window.location.href = '/';
                        }
                    });
                } else {
                    // Check localStorage as fallback
                    const storedUser = localStorage.getItem('ai_studio_user');
                    
                    if (storedUser) {
                        try {
                            const user = JSON.parse(storedUser);
                            console.log('üì¶ Using stored user:', user.email);
                            document.getElementById('userEmail').textContent = user.email;
                            loadDriveSettings();
                        } catch (e) {
                            console.error('Invalid stored user data');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 1000);
                        }
                    } else {
                        console.log('‚ùå No authentication found');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    }
                }

            } catch (error) {
                console.error('Auth check error:', error);
                showError();
            } finally {
                isCheckingAuth = false;
            }
        }

        function showError() {
            document.querySelector('.welcome-section').innerHTML = `
                <h2 style="color: #ff6b6b;">Authentifizierungsfehler</h2>
                <p>Bitte <a href="/" style="color: #667eea;">neu anmelden</a></p>
            `;
        }

        async function signOut() {
            console.log('üëã Signing out...');
            
            if (supabase) {
                await supabase.auth.signOut();
            }
            
            localStorage.removeItem('ai_studio_user');
            localStorage.removeItem('drive_folder_link');
            window.location.href = '/';
        }

        function navigateTo(path) {
            // Check if Drive is configured
            const driveLink = localStorage.getItem('drive_folder_link');
            if (!driveLink) {
                if (confirm('Bitte konfiguriere zuerst deinen Google Drive Ordner. Jetzt einrichten?')) {
                    openDriveSettings();
                }
                return;
            }
            
            window.location.href = path;
        }

        // Google Drive Settings
        function openDriveSettings() {
            document.getElementById('driveSettingsModal').classList.add('show');
            const savedLink = localStorage.getItem('drive_folder_link');
            if (savedLink) {
                document.getElementById('driveFolderLink').value = savedLink;
            }
        }

        function closeDriveSettings() {
            document.getElementById('driveSettingsModal').classList.remove('show');
        }

        function saveDriveSettings() {
            const link = document.getElementById('driveFolderLink').value.trim();
            
            if (!link) {
                alert('Bitte gib einen g√ºltigen Google Drive Link ein');
                return;
            }
            
            // Basic validation
            if (!link.includes('drive.google.com')) {
                alert('Bitte gib einen g√ºltigen Google Drive Link ein');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('drive_folder_link', link);
            
            // Update UI
            loadDriveSettings();
            closeDriveSettings();
            
            alert('‚úÖ Drive Ordner gespeichert!');
        }

        function loadDriveSettings() {
            const savedLink = localStorage.getItem('drive_folder_link');
            if (savedLink) {
                document.getElementById('driveStatus').style.display = 'block';
                // Extract folder name from link if possible
                const folderName = savedLink.split('/').pop() || 'Konfiguriert';
                document.getElementById('driveFolderPath').textContent = folderName;
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>
</html>

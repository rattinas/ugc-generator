<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Go 2 Flow Studio</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/go2flow-styles.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .dashboard {
            min-height: 100vh;
            background: var(--g2f-bg-primary);
        }
        
        .welcome-section {
            padding: 40px 0;
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 24px;
            padding-right: 24px;
        }
        
        .welcome-section h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--g2f-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-section p {
            font-size: 16px;
            color: var(--g2f-text-secondary);
        }
        
        .drive-status {
            margin-top: 20px;
            padding: 16px;
            background: var(--g2f-bg-card);
            border: 1px solid var(--g2f-border);
            border-radius: var(--g2f-radius-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .drive-status p {
            margin: 0;
            color: var(--g2f-text-secondary);
        }
        
        .drive-status strong {
            color: var(--g2f-accent);
        }
        
        .section {
            margin: 48px 0;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--g2f-text-primary);
            margin-bottom: 24px;
        }
        
        .use-case-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-dropdown {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--g2f-bg-secondary);
            border: 1px solid var(--g2f-border);
            border-radius: var(--g2f-radius-full);
            color: var(--g2f-text-secondary);
            font-size: 14px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .drive-btn {
            background: var(--g2f-bg-secondary);
            border: 1px solid var(--g2f-accent);
            color: var(--g2f-accent);
        }
        
        .drive-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header Component -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo-container" onclick="window.location.href='/dashboard.html'">
                    <img src="https://onecdn.io/media/6133cb85-37e0-4e06-ab28-ec5cc5257fd9/md2x" 
                         alt="Go 2 Flow" 
                         class="logo-img">
                    <span class="logo-text">Go 2 Flow Studio</span>
                </div>
                
                <div class="user-menu">
                    <!-- Google Drive Settings -->
                    <button onclick="openDriveSettings()" class="btn btn-small drive-btn">
                        <span>üìÅ</span> Drive Ordner
                    </button>
                    
                    <div class="user-dropdown">
                        <span id="userEmail">User</span>
                        <button onclick="signOut()" class="btn btn-small btn-secondary">Abmelden</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h2>Willkommen im Go 2 Flow Studio!</h2>
                <p>Erstelle photorealistische E-Commerce Bilder mit KI-Unterst√ºtzung</p>
                
                <!-- Drive Status -->
                <div id="driveStatus" class="drive-status" style="display: none;">
                    <p>üìÅ Google Drive Ordner: <strong id="driveFolderPath">Nicht konfiguriert</strong></p>
                    <button onclick="openDriveSettings()" class="btn btn-small btn-accent">√Ñndern</button>
                </div>
            </section>

            <!-- Use Cases -->
            <section class="section">
                <h3 class="section-title">W√§hle deinen Photography Style</h3>
                <div class="use-case-grid">
                    <!-- Fashion -->
                    <div class="use-case-card" onclick="navigateTo('/pages/fashion.html')">
                        <div class="card-badge">Beliebt</div>
                        <div class="card-icon">üëó</div>
                        <h4>Fashion & Apparel</h4>
                        <p>Kleidung, Schuhe & Accessoires auf Models</p>
                        <div class="card-features">
                            <span>UGC Content</span>
                            <span>Spiegel-Selfies</span>
                            <span>iPhone Shots</span>
                            <span>Model-Konfiguration</span>
                        </div>
                    </div>

                    <!-- Product -->
                    <div class="use-case-card" onclick="navigateTo('/pages/product.html')">
                        <div class="card-badge">Erweitert</div>
                        <div class="card-icon">üì¶</div>
                        <h4>Product Photography</h4>
                        <p>Objekte in Aktion & Produktdemos</p>
                        <div class="card-features">
                            <span>Hand Modeling</span>
                            <span>In-Use Demos</span>
                            <span>UGC Style</span>
                            <span>360¬∞ Views</span>
                        </div>
                    </div>

                    <!-- Beauty -->
                    <div class="use-case-card" onclick="navigateTo('/pages/beauty.html')">
                        <div class="card-badge">Premium</div>
                        <div class="card-icon">üíÑ</div>
                        <h4>Beauty & Cosmetics</h4>
                        <p>Makeup, Skincare & Haircare</p>
                        <div class="card-features">
                            <span>Application Shots</span>
                            <span>Before/After</span>
                            <span>Texture Macros</span>
                        </div>
                    </div>

                    <!-- Food -->
                    <div class="use-case-card" onclick="navigateTo('/pages/food.html')">
                        <div class="card-icon">üçî</div>
                        <h4>Food & Beverage</h4>
                        <p>Restaurant-Style & Verpackungen</p>
                        <div class="card-features">
                            <span>Styled Plating</span>
                            <span>Action Cooking</span>
                            <span>Packaging Hero</span>
                        </div>
                    </div>

                    <!-- Jewelry -->
                    <div class="use-case-card" onclick="navigateTo('/pages/jewelry.html')">
                        <div class="card-icon">üíé</div>
                        <h4>Jewelry & Watches</h4>
                        <p>Schmuck & Luxury Items</p>
                        <div class="card-features">
                            <span>Macro Details</span>
                            <span>Luxury Staging</span>
                            <span>Worn Shots</span>
                        </div>
                    </div>

                    <!-- Sports -->
                    <div class="use-case-card" onclick="navigateTo('/pages/sports.html')">
                        <div class="card-icon">‚öΩ</div>
                        <h4>Sports & Fitness</h4>
                        <p>Equipment & Activewear</p>
                        <div class="card-features">
                            <span>Action Shots</span>
                            <span>Equipment Demo</span>
                            <span>Lifestyle Active</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Google Drive Settings Modal -->
    <div id="driveSettingsModal" class="modal">
        <div class="modal-content">
            <h3>Google Drive Einstellungen</h3>
            <p style="color: var(--g2f-text-secondary); margin-bottom: 20px;">
                Gib den Link zu deinem Google Drive Ordner ein, in dem die generierten Bilder gespeichert werden sollen:
            </p>
            
            <div class="form-group">
                <label>Google Drive Ordner Link:</label>
                <input type="text" 
                       id="driveFolderLink" 
                       placeholder="https://drive.google.com/drive/folders/..." 
                       class="form-control">
                <small style="color: var(--g2f-text-secondary); display: block; margin-top: 8px;">
                    Der Ordner muss f√ºr Make.com freigegeben sein
                </small>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDriveSettings()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveDriveSettings()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vnodqwehipwpusrthurk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZub2Rxd2VoaXB3cHVzcnRodXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTA5NTcsImV4cCI6MjA3MDMyNjk1N30.LSMyYLt7URx1G1NFKZAqXTrzVHwjtbvOzeuxLZy0u-Q';
        
        let supabase = null;
        let isCheckingAuth = false;

        async function checkAuth() {
            if (isCheckingAuth) return;
            isCheckingAuth = true;

            console.log('üîí Checking authentication...');

            try {
                // Initialize Supabase
                if (!supabase && typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }

                if (!supabase) {
                    console.error('Supabase not initialized');
                    showError();
                    return;
                }

                // Check session
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('Session check error:', error);
                    showError();
                    return;
                }

                if (session) {
                    console.log('‚úÖ User authenticated:', session.user.email);
                    document.getElementById('userEmail').textContent = session.user.email;
                    
                    // Load Drive settings
                    loadDriveSettings();
                    
                    // Setup auth listener for logout
                    supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_OUT') {
                            window.location.href = '/';
                        }
                    });
                } else {
                    // Check localStorage as fallback
                    const storedUser = localStorage.getItem('g2f_studio_user');
                    
                    if (storedUser) {
                        try {
                            const user = JSON.parse(storedUser);
                            console.log('üì¶ Using stored user:', user.email);
                            document.getElementById('userEmail').textContent = user.email;
                            loadDriveSettings();
                        } catch (e) {
                            console.error('Invalid stored user data');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 1000);
                        }
                    } else {
                        console.log('‚ùå No authentication found');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    }
                }

            } catch (error) {
                console.error('Auth check error:', error);
                showError();
            } finally {
                isCheckingAuth = false;
            }
        }

        function showError() {
            document.querySelector('.welcome-section').innerHTML = `
                <h2 style="color: var(--g2f-accent);">Authentifizierungsfehler</h2>
                <p>Bitte <a href="/" style="color: var(--g2f-accent);">neu anmelden</a></p>
            `;
        }

        async function signOut() {
            console.log('üëã Signing out...');
            
            if (supabase) {
                await supabase.auth.signOut();
            }
            
            localStorage.removeItem('g2f_studio_user');
            localStorage.removeItem('drive_folder_link');
            window.location.href = '/';
        }

        function navigateTo(path) {
            // Check if Drive is configured
            const driveLink = localStorage.getItem('drive_folder_link');
            if (!driveLink) {
                if (confirm('Bitte konfiguriere zuerst deinen Google Drive Ordner. Jetzt einrichten?')) {
                    openDriveSettings();
                }
                return;
            }
            
            window.location.href = path;
        }

        // Google Drive Settings
        function openDriveSettings() {
            document.getElementById('driveSettingsModal').classList.add('show');
            const savedLink = localStorage.getItem('drive_folder_link');
            if (savedLink) {
                document.getElementById('driveFolderLink').value = savedLink;
            }
        }

        function closeDriveSettings() {
            document.getElementById('driveSettingsModal').classList.remove('show');
        }

        function saveDriveSettings() {
            const link = document.getElementById('driveFolderLink').value.trim();
            
            if (!link) {
                alert('Bitte gib einen g√ºltigen Google Drive Link ein');
                return;
            }
            
            // Basic validation
            if (!link.includes('drive.google.com')) {
                alert('Bitte gib einen g√ºltigen Google Drive Link ein');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('drive_folder_link', link);
            
            // Update UI
            loadDriveSettings();
            closeDriveSettings();
            
            alert('‚úÖ Drive Ordner gespeichert!');
        }

        function loadDriveSettings() {
            const savedLink = localStorage.getItem('drive_folder_link');
            if (savedLink) {
                document.getElementById('driveStatus').style.display = 'flex';
                // Extract folder name from link if possible
                const folderName = savedLink.split('/').pop() || 'Konfiguriert';
                document.getElementById('driveFolderPath').textContent = folderName;
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>
</html>

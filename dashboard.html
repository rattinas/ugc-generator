<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Studio</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header Component -->
        <header id="mainHeader" class="main-header">
            <div class="header-content">
                <h1 class="logo" onclick="window.location.href='/dashboard.html'">
                    AI<span>STUDIO</span>
                </h1>
                
                <div class="user-menu">
                    <div class="credits-display">
                        <span class="credits-icon">üí≥</span>
                        <span id="creditsAmount">100</span> Credits
                    </div>
                    
                    <div class="user-dropdown">
                        <span id="userEmail">User</span>
                        <button onclick="signOut()" class="btn btn-small">Abmelden</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h2>Willkommen zur√ºck!</h2>
                <p>Was m√∂chtest du heute fotografieren?</p>
            </section>

            <!-- Use Cases -->
            <section class="section">
                <h3 class="section-title">W√§hle deinen Use Case</h3>
                <div class="use-case-grid">
                    <!-- Fashion -->
                    <div class="use-case-card" onclick="navigateTo('/pages/fashion.html')">
                        <div class="card-badge">Beliebt</div>
                        <div class="card-icon">üëó</div>
                        <h4>Fashion & Apparel</h4>
                        <p>Kleidung, Schuhe & Accessoires auf Models</p>
                        <div class="card-features">
                            <span>Model-Konfiguration</span>
                            <span>Lifestyle Scenes</span>
                        </div>
                        <div class="card-credits">2 Credits</div>
                    </div>

                    <!-- Product -->
                    <div class="use-case-card" onclick="navigateTo('/pages/product.html')">
                        <div class="card-icon">üì¶</div>
                        <h4>Product Photography</h4>
                        <p>Objekte in Aktion & Produktdemos</p>
                        <div class="card-features">
                            <span>Hand Modeling</span>
                            <span>In-Use Demos</span>
                        </div>
                        <div class="card-credits">1 Credit</div>
                    </div>

                    <!-- Beauty -->
                    <div class="use-case-card" onclick="navigateTo('/pages/beauty.html')">
                        <div class="card-badge">Neu</div>
                        <div class="card-icon">üíÑ</div>
                        <h4>Beauty & Cosmetics</h4>
                        <p>Makeup, Skincare & Haircare</p>
                        <div class="card-features">
                            <span>Application Shots</span>
                            <span>Before/After</span>
                        </div>
                        <div class="card-credits">2 Credits</div>
                    </div>

                    <!-- Food -->
                    <div class="use-case-card" onclick="navigateTo('/pages/food.html')">
                        <div class="card-icon">üçî</div>
                        <h4>Food & Beverage</h4>
                        <p>Restaurant-Style & Verpackungen</p>
                        <div class="card-features">
                            <span>Styled Plating</span>
                            <span>Action Cooking</span>
                        </div>
                        <div class="card-credits">1 Credit</div>
                    </div>

                    <!-- Jewelry -->
                    <div class="use-case-card" onclick="navigateTo('/pages/jewelry.html')">
                        <div class="card-icon">üíé</div>
                        <h4>Jewelry & Watches</h4>
                        <p>Schmuck & Luxury Items</p>
                        <div class="card-features">
                            <span>Macro Details</span>
                            <span>Luxury Staging</span>
                        </div>
                        <div class="card-credits">2 Credits</div>
                    </div>

                    <!-- Sports -->
                    <div class="use-case-card" onclick="navigateTo('/pages/sports.html')">
                        <div class="card-icon">‚öΩ</div>
                        <h4>Sports & Fitness</h4>
                        <p>Equipment & Activewear</p>
                        <div class="card-features">
                            <span>Action Shots</span>
                            <span>Lifestyle Active</span>
                        </div>
                        <div class="card-credits">2 Credits</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vnodqwehipwpusrthurk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZub2Rxd2VoaXB3cHVzcnRodXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTA5NTcsImV4cCI6MjA3MDMyNjk1N30.LSMyYLt7URx1G1NFKZAqXTrzVHwjtbvOzeuxLZy0u-Q';
        
        let supabase = null;
        let isCheckingAuth = false; // Prevent multiple checks

        async function checkAuth() {
            // Prevent redirect loop
            if (isCheckingAuth) return;
            isCheckingAuth = true;

            console.log('üîí Checking authentication...');

            try {
                // Initialize Supabase
                if (!supabase && typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }

                if (!supabase) {
                    console.error('Supabase not initialized');
                    // Don't redirect, just show error
                    showError();
                    return;
                }

                // Check session
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('Session check error:', error);
                    showError();
                    return;
                }

                if (session) {
                    console.log('‚úÖ User authenticated:', session.user.email);
                    // Update UI with user info
                    document.getElementById('userEmail').textContent = session.user.email;
                    
                    // Setup auth listener for logout
                    supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_OUT') {
                            window.location.href = '/';
                        }
                    });
                } else {
                    // No session - check localStorage as fallback
                    const storedUser = localStorage.getItem('ai_studio_user');
                    
                    if (storedUser) {
                        try {
                            const user = JSON.parse(storedUser);
                            console.log('üì¶ Using stored user:', user.email);
                            document.getElementById('userEmail').textContent = user.email;
                        } catch (e) {
                            console.error('Invalid stored user data');
                            // Only redirect if really no auth
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 1000);
                        }
                    } else {
                        console.log('‚ùå No authentication found');
                        // Redirect to login after delay to prevent loop
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    }
                }

            } catch (error) {
                console.error('Auth check error:', error);
                showError();
            } finally {
                isCheckingAuth = false;
            }
        }

        function showError() {
            document.querySelector('.welcome-section').innerHTML = `
                <h2 style="color: #ff6b6b;">Authentifizierungsfehler</h2>
                <p>Bitte <a href="/" style="color: #667eea;">neu anmelden</a></p>
            `;
        }

        async function signOut() {
            console.log('üëã Signing out...');
            
            if (supabase) {
                await supabase.auth.signOut();
            }
            
            localStorage.removeItem('ai_studio_user');
            window.location.href = '/';
        }

        function navigateTo(path) {
            // Check credits before navigation
            const creditsElement = document.getElementById('creditsAmount');
            const credits = parseInt(creditsElement?.textContent || 0);
            
            if (credits < 1) {
                if (confirm('Du hast keine Credits mehr. M√∂chtest du welche kaufen?')) {
                    window.location.href = '/pages/billing.html';
                }
                return;
            }
            
            window.location.href = path;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>
</html>
